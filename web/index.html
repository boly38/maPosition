<!DOCTYPE HTML>
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>maPosition</title>
  <link rel="stylesheet" href="style.css"/>

  <link rel="stylesheet" href="https://openlayers.org/en/v4.2.0/css/ol.css" type="text/css"/>
     <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
     <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
     <script src="https://openlayers.org/en/v4.2.0/build/ol.js"></script>
     <style>
       a.skiplink {
         position: absolute;
         clip: rect(1px, 1px, 1px, 1px);
         padding: 0;
         border: 0;
         height: 1px;
         width: 1px;
         overflow: hidden;
       }
       a.skiplink:focus {
         clip: auto;
         height: auto;
         width: auto;
         background-color: #fff;
         padding: 0.3em;
       }
       #map:focus {
         outline: #4A74A8 solid 0.15em;
       }
     </style>

     <script
     src="https://code.jquery.com/jquery-3.2.1.js"
     integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE="
     crossorigin="anonymous"></script>

 </head>
<body>

  <div id="GKbutton"  class="leftButton"><div onclick="gk()"          title="Voir les G&eacute;oKrets du coin...">GK</div></div>
  <div id="WMbutton"  class="leftButton"><span onclick="wm()"          title="Voir les Waymarks du coin...">WM</span></div>
  <div id="POSbutton" class="leftButton"><span onclick="getLocation()" title="Positionnement par le navigateur">Pos</span></div>
  <div id="GREbutton" class="leftButton"><span onclick="goGre()"       title="Aller à Grenoble">Gre</span></div>
  <div style="position:absolute; left:50px; top:10px; z-index: 99;" id="popup" class="popup"></div>
  <a class="skiplink" href="#map">Go to map</a>
  <div id="map" class="map" tabindex="0"></div>
  <!--
  <button id="zoom-out">Zoom out</button>
  <button id="zoom-in">Zoom in</button>
-->
<script>
  // Grenoble
  var latGRE= 45.184233;
  var lonGRE=  5.726055;
  var zoom = 12;
  var map;


  // var fromProjection = new ol.Projection("EPSG:4326");   // Transform from WGS 1984
  // var toProjection   = new ol.Projection("EPSG:900913"); // to Spherical Mercator Projection

  function _getPopup() {
    return $( "#popup" );
  }

  function _popupMessage(msg) {
    _getPopup().html( msg );
    _getPopup().show();
  }

  function _getLonLatProjection(lat, lon) {
    var myLonLat = [lon, lat]; // caution partner, read on...
    var myLonLatProjection = ol.proj.fromLonLat(myLonLat);
    return myLonLatProjection;
  }

  function _getCenterLonLat() {
    var curCenter = map.getView().getCenter();
    return  ol.proj.toLonLat(curCenter);
  }


  // https://openlayers.org/en/latest/doc/faq.html
  function openMap(lat, lon) {
    map = new ol.Map({
      layers: [
        new ol.layer.Tile({
          source: new ol.source.OSM()
        })
      ],
      target: 'map',
      controls: ol.control.defaults({
        attributionOptions: ({
          collapsible: false
        })
      }),
      view: new ol.View({
        center: _getLonLatProjection(lat, lon),
        zoom: zoom
      })
    });

    // display on click
    map.on('click', function(evt) {
      var feature = map.forEachFeatureAtPixel(evt.pixel,
          function(feature, layer) {
            return feature;
          });
      if (feature) {
        console.info(feature);
        // document.getElementById("popup").innerHTML = feature.getProperties().popupContent;
        var pcontent = feature.getProperties().popupContent;
        _popupMessage(pcontent);
        return;
      }
      _getPopup().hide();
    });

    // change mouse cursor when over marker
    // https://stackoverflow.com/questions/26022029/how-to-change-the-cursor-on-hover-in-openlayers-3
    var target = map.getTarget();
    var jTarget = typeof target === "string" ? $("#" + target) : $(target);
    // change mouse cursor when over marker
    $(map.getViewport()).on('mousemove', function (e) {
        var pixel = map.getEventPixel(e.originalEvent);
        var hit = map.forEachFeatureAtPixel(pixel, function (feature, layer) {
            return true;
        });
        if (hit) {
            jTarget.css("cursor", "pointer");
        } else {
            jTarget.css("cursor", "");
        }
    });

  }

/*
  document.getElementById('zoom-out').onclick = function() {
    var view = map.getView();
    var zoom = view.getZoom();
    view.setZoom(zoom - 1);
  };

  document.getElementById('zoom-in').onclick = function() {
    var view = map.getView();
    var zoom = view.getZoom();
    view.setZoom(zoom + 1);
  };
*/

  function getBoundsFromMap() {
    var cex = map.getView().calculateExtent(map.getSize());
    var exA = ol.proj.toLonLat([cex[0],cex[1]]);
    var exB = ol.proj.toLonLat([cex[2],cex[3]]);
    return [exA[0], exA[1], exB[0], exB[1]];
  }
  function getCenterFromMap() {
    return ol.proj.toLonLat(map.getView().getCenter());
  }

  function assumeNumber(item, itemDesc) {
    if (isNaN(item)) {
      throw "Attendu float pour " + itemDesc;
    }
  }

  function getGKUrl(latTL, lonTL, latBR, lonBR) {
    assumeNumber(latTL, "GKUrl::latTL");
    assumeNumber(lonTL, "GKUrl::lonTL");
    assumeNumber(latBR, "GKUrl::latBR");
    assumeNumber(lonBR, "GKUrl::lonBR");
    return "https://api.geokretymap.org/geojson"
    + "?latTL=" + latTL + "&lonTL=" + lonTL
    + "&latBR=" + latBR + "&lonBR=" + lonBR
    + "&limit=500&daysFrom=0&daysTo=-1";
  }

  function gk() {
    gkDev = false;
    console.info("GK " + (gkDev?"DEV":"PROD"));
    var bounds = getBoundsFromMap();
    console.info(bounds);
    // appel de https://api.geokretymap.org/geojson?latTL=45.229224356422&lonTL=5.7898879692337&latBR=45.139241643578&lonBR=5.6622220307663&limit=500&daysFrom=0&daysTo=-1
    var gkUrl = getGKUrl(bounds[3], bounds[2], bounds[1], bounds[0]);
    console.info(gkUrl);
    if (!gkDev) {
      _popupMessage("Chargement de geokrets...");
      $.getJSON( gkUrl, function( data ) {
        console.info(data);


        var gkSource = new ol.source.Vector({});
        gkSource.addFeatures((new ol.format.GeoJSON()).readFeatures(data,{
          featureProjection: 'EPSG:3857'
        }));

        var stroke = new ol.style.Stroke({color: 'black', width: 1});
        var fill = new ol.style.Fill({color: 'red'});
        var starStyle = new ol.style.Style({
          image: new ol.style.Icon({
            scale: 0.15,
            opacity: 1,
            src: "https://geokretymap.org/images/gk_logo.png"
          })
        });
        var gkCount = 0;
        gkSource.forEachFeature(function(feat) {
          feat.setStyle(starStyle);
          gkCount++;
        });
        if (gkCount > 0) {
          _popupMessage("" + gkCount + " Géokret(s) de plus");
        }



        var gkLayer = new ol.layer.Vector({
          source: gkSource
        });
        map.addLayer(gkLayer);
      });
    }
  }

  function corsProxyMe(url) {
    // var CORSproxy = "https://crossorigin.me/"; // lentissime
    var CORSproxy = "https://cors-anywhere.herokuapp.com/";
    return CORSproxy + url;
  }

  function getWMUrl(rayonKm, cLat, cLon, page) {
    // return "wmExample.txt";
    var wmUrl = "http://www.waymarking.com/wm/search.aspx?f=1&lat=" + cLat
    + "&lon=" + cLon + "&t=6&id=lat:" + cLat + "%20lon:"+ cLon + "&wo=True&r="+rayonKm+"&st=2"
    if (page > 1) {
      wmUrl = wmUrl + "&p=" + page;
    }
    // Grenoble centre page 1 = 25 resultats //
    // wmUrl = "http://www.waymarking.com/wm/search.aspx?f=1&lat=45.184233&lon=5.726055&t=6&id=lat:45.184233%20lon:5.726055&wo=True&r=5&sg=d071184f-347f-4a82-9d32-b2936cbd8618&st=2";
    return corsProxyMe(wmUrl);

  }

  function transformToFeature(wmarkers) {
    var rez = {
        "type":"FeatureCollection",
        "features":[] };
    for(var wmi = 0; wmi < wmarkers.length; wmi++) {
      var wm = wmarkers[wmi];
      var f = {
        "geometry":{
          "type":"Point",
          "coordinates":[
            wm.lng,
            wm.lat
          ]
        },
        "type":"Feature",
        "properties":{
          "code":wm.code,
          "popupContent":"<b><a href=\"#\" target=\"_blank\">" + wm.title + "</a></b><br/>"
          +" Code: " + wm.code + " <br/>"
          +" Description: " + wm.desc + " <br/>"
          +" Type: " + wm.icon
        }
      };
      rez.features.push(f)
    }
    return rez;
  }

  function _getMarkersLineFromWaymarking(htmlData) {
    var lines = htmlData.split('\n');
    // DEBUG // console.info("nb ligne:" + lines.length);
    var xmMarkersPrefix = "var markers = ";
    var markersLine = null;
    for(var line = 0; line < lines.length; line++) {
      var curLine = lines[line];
      if (curLine.substring(0,xmMarkersPrefix.length) == xmMarkersPrefix) {
        // DEBUG // console.info(curLine);
        markersLine = curLine;
      }
    }
    return markersLine;
  }

  function _wmPage(wlat, wlon, page) {
        console.info("WM " + (wmDev?"DEV":"PROD"));
        var rayonKm = 10;
        var wmUrl = getWMUrl(rayonKm, wlat, wlon, page);
        console.info(wmUrl);
        if (!wmDev) {
          _popupMessage("Chargement de waymarks " + rayonKm + "km autour du centre (page" + page + ")...");
          $.ajax({
              dataType: "txt",
              url: wmUrl,
              error: function (data) {
                console.info(data);
                var markersLine = _getMarkersLineFromWaymarking(data.responseText)
                if (markersLine == null) {
                  console.info("impossible de charger les waymarks");
                  return 0;
                }
                eval(markersLine);
                console.info(markers);
                var feat = transformToFeature(markers);
                console.info(feat);
                var wmSource = new ol.source.Vector({});
                wmSource.addFeatures((new ol.format.GeoJSON()).readFeatures(feat,{
                  featureProjection: 'EPSG:3857'
                }));

                var wmLayer = new ol.layer.Vector({
                  source: wmSource
                });
                map.addLayer(wmLayer);
                wmCount = wmCount + markers.length;
                if (markers.length == 25 && page < 10) {
                  _popupMessage("" + markers.length + " waymark(s) de plus! (page" + page + ")");
                  _wmPage(wlat, wlon, page+1);
                } else {
                  _popupMessage("" + wmCount + " waymark(s) de plus!");
                }
              }
          });
        }
  }
  var wmCount = 0;

  function wm() {
    wmDev = false;
    var curLonLat = _getCenterLonLat();
    wmCount = 0;
    _wmPage(curLonLat[1], curLonLat[0], 1);
  }

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPosition);
    } else {
      _popupMessage("Geolocation is not supported by this browser.");
    }
  }
  function showPosition(position) {
    lat = position.coords.latitude;
    lon = position.coords.longitude;
    _popupMessage("lat: " + lat +", lon: " + lon),
    console.info("showPosition ok " + lat + "," + lon);
    map.getView().setCenter( _getLonLatProjection(lat, lon) );
  }
  function goGre() {
    map.getView().setCenter( _getLonLatProjection(latGRE, lonGRE) );
    _popupMessage("Bienvenue à Grenoble!");
  }
  _getPopup().hide("");
  openMap(latGRE, lonGRE);

</script>
</body>
</html>
